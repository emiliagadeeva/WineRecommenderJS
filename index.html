<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wine Explorer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <script src="sentence-transformer-loader.js"></script>
    <style>
        .slider-value { display: inline-block; min-width: 50px; font-weight: bold; color: #0d6efd; }
        .filter-section { background-color: #f8f9fa; border-radius: 8px; padding: 20px; margin-bottom: 20px; }
        .filter-section h6 { color: #495057; border-bottom: 2px solid #dee2e6; padding-bottom: 10px; margin-bottom: 15px; }
        .wine-card { transition: transform 0.3s ease, box-shadow 0.3s ease; border: 1px solid #dee2e6; border-radius: 10px; overflow: hidden; }
        .wine-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .wine-type-badge { position: absolute; top: 10px; right: 10px; z-index: 1; }
        .similarity-meter { height: 8px; background-color: #e9ecef; border-radius: 4px; overflow: hidden; margin: 10px 0; }
        .similarity-fill { height: 100%; background: linear-gradient(90deg, #ff6b6b, #ffd93d, #6bcf7f); transition: width 0.5s ease; }
        .country-flag { width: 20px; height: auto; margin-right: 8px; border-radius: 2px; }
        .price-tag { font-size: 1.1em; font-weight: bold; color: #198754; }
        .selected-wine-card { border: 2px solid #0d6efd; background-color: #f0f8ff; }
        .selected-wine-card .remove-btn { opacity: 0; transition: opacity 0.3s ease; }
        .selected-wine-card:hover .remove-btn { opacity: 1; }
        .wine-select-item { cursor: pointer; padding: 8px 12px; border-radius: 6px; margin: 2px 0; transition: all 0.2s ease; }
        .wine-select-item:hover { background-color: #e9ecef; }
        .wine-select-item.selected { background-color: #0d6efd; color: white; }
        .badge-small { font-size: 0.7em; padding: 2px 6px; }
        .nav-tabs .nav-link { border: none; color: #6c757d; font-weight: 500; padding: 12px 20px; }
        .nav-tabs .nav-link.active { color: #0d6efd; border-bottom: 3px solid #0d6efd; background-color: transparent; }
        .nav-tabs .nav-link:hover:not(.active) { color: #495057; }
        .tab-pane { animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .hint-bubble { position: absolute; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 10px; width: 300px; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.1); font-size: 0.9em; }
        .llm-loading { background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: loading 1.5s infinite; border-radius: 4px; }
        @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        .data-loading { background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="text-center mb-5">
            <h1 class="display-4 text-danger"><i class="bi bi-cup-straw"></i> Wine Explorer</h1>
            <p class="lead text-muted">–¢—Ä–∏ —Å–ø–æ—Å–æ–±–∞ –Ω–∞–π—Ç–∏ –∏–¥–µ–∞–ª—å–Ω–æ–µ –≤–∏–Ω–æ —Å AI-–ø–æ–º–æ—â–Ω–∏–∫–æ–º</p>
        </div>

        <ul class="nav nav-tabs mb-4" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="filter-tab" data-bs-toggle="tab" data-bs-target="#filter-tab-pane" type="button">
                    <i class="bi bi-funnel"></i> –ü–æ–∏—Å–∫ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="taste-tab" data-bs-toggle="tab" data-bs-target="#taste-tab-pane" type="button">
                    <i class="bi bi-heart"></i> –ü–æ –≤–∞—à–∏–º –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è–º
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="simple-tab" data-bs-toggle="tab" data-bs-target="#simple-tab-pane" type="button">
                    <i class="bi bi-search"></i> –ü—Ä–æ—Å—Ç–æ–π –ø–æ–∏—Å–∫
                </button>
            </li>
        </ul>

        <div class="tab-content" id="mainTabsContent">
            <!-- –¢–ê–ë 1: –ü–æ–∏—Å–∫ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ -->
            <div class="tab-pane fade show active" id="filter-tab-pane" role="tabpanel">
                <div class="row">
                    <div class="col-lg-4">
                        <div class="filter-section">
                            <h6><i class="bi bi-funnel"></i> –§–∏–ª—å—Ç—Ä—ã –ø–æ–∏—Å–∫–∞</h6>
                            
                            <div class="mb-4">
                                <label for="searchQuery" class="form-label">–û–ø–∏—à–∏—Ç–µ, —á—Ç–æ –≤—ã –∏—â–µ—Ç–µ:</label>
                                <textarea class="form-control" id="searchQuery" rows="3" 
                                          placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ë–æ–≥–∞—Ç–æ–µ –∫—Ä–∞—Å–Ω–æ–µ –≤–∏–Ω–æ –¥–ª—è —Å—Ç–µ–π–∫–∞ –∏–ª–∏ –ª–µ–≥–∫–æ–µ –±–µ–ª–æ–µ –¥–ª—è —Ä—ã–±—ã"></textarea>
                            </div>
                            
                            <div class="mb-4">
                                <label class="form-label">–¢–∏–ø –≤–∏–Ω–∞ (Variety):</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-graph-up"></i></span>
                                    <select class="form-select" id="varietyFilter">
                                        <option value="">–í—Å–µ —Å–æ—Ä—Ç–∞</option>
                                        <option value="loading" disabled>–ó–∞–≥—Ä—É–∑–∫–∞...</option>
                                    </select>
                                </div>
                                <div class="form-text">–û—Å–Ω–æ–≤–Ω–æ–π —Å–æ—Ä—Ç –≤–∏–Ω–æ–≥—Ä–∞–¥–∞ –∏–ª–∏ —Å–º–µ—Å—å</div>
                            </div>
                            
                            <div class="mb-4">
                                <label class="form-label">–°—Ç—Ä–∞–Ω–∞ –ø—Ä–æ–∏—Å—Ö–æ–∂–¥–µ–Ω–∏—è:</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-globe"></i></span>
                                    <select class="form-select" id="countryFilter">
                                        <option value="">–í—Å–µ —Å—Ç—Ä–∞–Ω—ã</option>
                                        <option value="loading" disabled>–ó–∞–≥—Ä—É–∑–∫–∞...</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <label class="form-label">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞: <span id="priceValue" class="slider-value">$100</span></label>
                                <input type="range" class="form-range" id="maxPriceFilter" min="10" max="500" step="5" value="100">
                                <div class="d-flex justify-content-between">
                                    <small>$10</small>
                                    <small>$500+</small>
                                </div>
                            </div>
                            
                            <div class="d-grid gap-2">
                                <button class="btn btn-danger btn-lg" onclick="getFilteredRecommendations()">
                                    <i class="bi bi-search"></i> –ù–∞–π—Ç–∏ –≤–∏–Ω–∞
                                </button>
                                <button class="btn btn-outline-secondary" onclick="resetFilters()">
                                    <i class="bi bi-arrow-clockwise"></i> –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
                                </button>
                            </div>
                            
                            <div class="mt-3">
                                <button class="btn btn-sm btn-outline-info w-100" onclick="refreshData()">
                                    <i class="bi bi-arrow-clockwise"></i> –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
                                </button>
                                <small class="text-muted d-block mt-1">–ï—Å–ª–∏ —Ñ–∏–ª—å—Ç—Ä—ã –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-8">
                        <div id="filterResultsSection" style="display: none;">
                            <div id="filterLLMComment" class="card mb-4">
                                <div class="card-header bg-danger text-white">
                                    <i class="bi bi-chat-left-text"></i> AI-—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è
                                </div>
                                <div class="card-body">
                                    <p id="filterLLMCommentText" class="fst-italic mb-0"></p>
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h3 id="filterResultsCount">–ù–∞–π–¥–µ–Ω–æ 0 –≤–∏–Ω</h3>
                                <div class="btn-group" role="group">
                                    <button class="btn btn-outline-secondary" onclick="sortResults('similarity', 'filter')">
                                        <i class="bi bi-sort-up"></i> –ü–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏
                                    </button>
                                    <button class="btn btn-outline-secondary" onclick="sortResults('price', 'filter')">
                                        <i class="bi bi-currency-dollar"></i> –ü–æ —Ü–µ–Ω–µ
                                    </button>
                                    <button class="btn btn-outline-secondary" onclick="sortResults('rating', 'filter')">
                                        <i class="bi bi-star"></i> –ü–æ —Ä–µ–π—Ç–∏–Ω–≥—É
                                    </button>
                                </div>
                            </div>
                            
                            <div id="filterResultsContainer" class="row"></div>
                            
                            <nav id="filterPagination" class="mt-4" style="display: none;">
                                <ul class="pagination justify-content-center"></ul>
                            </nav>
                        </div>
                        
                        <div id="filterWelcome" class="text-center mt-5">
                            <div class="card border-0 bg-light">
                                <div class="card-body">
                                    <h3 class="text-muted mb-4">
                                        <i class="bi bi-funnel"></i> –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–∏–ª—å—Ç—Ä—ã –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞
                                    </h3>
                                    <p class="text-muted">
                                        –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –≤–∏–Ω–∞, —Å—Ç—Ä–∞–Ω—É –ø—Ä–æ–∏—Å—Ö–æ–∂–¥–µ–Ω–∏—è –∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é —Ü–µ–Ω—É,<br>
                                        —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ –∏–¥–µ–∞–ª—å–Ω–æ–µ –≤–∏–Ω–æ –¥–ª—è –ª—é–±–æ–≥–æ —Å–ª—É—á–∞—è.
                                    </p>
                                    <div class="data-loading mt-4">
                                        <div class="spinner-border text-primary mb-3"></div>
                                        <p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ –≤–∏–Ω–∞—Ö...</p>
                                        <button class="btn btn-sm btn-outline-primary mt-2" onclick="refreshData()">
                                            <i class="bi bi-arrow-clockwise"></i> –û–±–Ω–æ–≤–∏—Ç—å
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –¢–ê–ë 2: –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –≤–∫—É—Å—É -->
            <div class="tab-pane fade" id="taste-tab-pane" role="tabpanel">
                <div class="row">
                    <div class="col-lg-4">
                        <div class="filter-section">
                            <h6><i class="bi bi-heart"></i> –í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à–∏ –ª—é–±–∏–º—ã–µ –≤–∏–Ω–∞</h6>
                            
                            <div class="mb-3">
                                <label class="form-label">–ü–æ–∏—Å–∫ –≤–∏–Ω:</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                                    <input type="text" class="form-control" id="wineSearch" 
                                           placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ, —Å–æ—Ä—Ç –∏–ª–∏ —Å—Ç—Ä–∞–Ω–∞" 
                                           onkeyup="filterWineList()">
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">–î–æ—Å—Ç—É–ø–Ω—ã–µ –≤–∏–Ω–∞:</label>
                                <div class="border rounded" style="max-height: 400px; overflow-y: auto;">
                                    <div id="wineSelectList">
                                        <div class="text-center p-3">
                                            <div class="spinner-border spinner-border-sm"></div>
                                            –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –≤–∏–Ω...
                                        </div>
                                    </div>
                                </div>
                                <div class="form-text">–í—ã–±–µ—Ä–∏—Ç–µ –≤–∏–Ω–∞, –∫–æ—Ç–æ—Ä—ã–µ –≤–∞–º –Ω—Ä–∞–≤—è—Ç—Å—è (–º–æ–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ)</div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">–í—ã–±—Ä–∞–Ω–æ –≤–∏–Ω: <span id="selectedCount" class="badge bg-primary">0</span></label>
                                <div id="selectedWinesList" class="border rounded p-2" style="min-height: 100px; max-height: 200px; overflow-y: auto;">
                                    <div class="text-center text-muted p-3"><i class="bi bi-inbox"></i><br>–í—ã–±–µ—Ä–∏—Ç–µ –≤–∏–Ω–∞ –∏–∑ —Å–ø–∏—Å–∫–∞</div>
                                </div>
                            </div>
                            
                            <div class="d-grid gap-2">
                                <button class="btn btn-success btn-lg" onclick="getTasteRecommendations()" id="tasteRecommendBtn" disabled>
                                    <i class="bi bi-magic"></i> –ü–æ–ª—É—á–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
                                </button>
                                <button class="btn btn-outline-danger" onclick="clearSelectedWines()">
                                    <i class="bi bi-trash"></i> –û—á–∏—Å—Ç–∏—Ç—å –≤—ã–±–æ—Ä
                                </button>
                            </div>
                        </div>
                        
                        <div class="alert alert-info mt-3">
                            <i class="bi bi-info-circle"></i> 
                            <strong>–°–æ–≤–µ—Ç:</strong> –í—ã–±–µ—Ä–∏—Ç–µ 3-5 –≤–∏–Ω, –∫–æ—Ç–æ—Ä—ã–µ –≤–∞–º –Ω—Ä–∞–≤—è—Ç—Å—è. 
                            –°–∏—Å—Ç–µ–º–∞ –Ω–∞–π–¥–µ—Ç –ø–æ—Ö–æ–∂–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–∞—à–∏—Ö –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π.
                        </div>
                    </div>
                    
                    <div class="col-lg-8">
                        <div id="tasteResultsSection" style="display: none;">
                            <div id="tasteLLMComment" class="card mb-4">
                                <div class="card-header bg-success text-white">
                                    <i class="bi bi-chat-left-text"></i> AI –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –≤–∞—à–∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è
                                </div>
                                <div class="card-body">
                                    <p id="tasteLLMCommentText" class="fst-italic mb-0"></p>
                                </div>
                            </div>
                            
                            <div id="tasteAnalysis" class="card mb-4">
                                <div class="card-header">
                                    <i class="bi bi-bar-chart"></i> –ê–Ω–∞–ª–∏–∑ –≤–∞—à–∏—Ö –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π
                                </div>
                                <div class="card-body">
                                    <div class="row" id="preferenceAnalysis">
                                        <div class="col-12">
                                            <div class="llm-loading" style="height: 100px;"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <h3 id="tasteResultsCount" class="mb-3">–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</h3>
                            <div id="tasteResultsContainer" class="row"></div>
                        </div>
                        
                        <div id="tasteWelcome" class="text-center mt-5">
                            <div class="card border-0 bg-light">
                                <div class="card-body">
                                    <h3 class="text-muted mb-4">
                                        <i class="bi bi-heart-fill text-danger"></i> –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
                                    </h3>
                                    <p class="text-muted mb-4">
                                        –í—ã–±–µ—Ä–∏—Ç–µ –≤–∏–Ω–∞, –∫–æ—Ç–æ—Ä—ã–µ –≤–∞–º –Ω—Ä–∞–≤—è—Ç—Å—è, –∏ –Ω–∞—à AI –Ω–∞–π–¥–µ—Ç –ø–æ—Ö–æ–∂–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã<br>
                                        –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–∞—à–∏—Ö –≤–∫—É—Å–æ–≤—ã—Ö –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π.
                                    </p>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <div class="card h-100">
                                                <div class="card-body">
                                                    <i class="bi bi-check2-circle display-4 text-success"></i>
                                                    <h5>1. –í—ã–±–µ—Ä–∏—Ç–µ</h5>
                                                    <p>–û—Ç–º–µ—Ç—å—Ç–µ –≤–∏–Ω–∞, –∫–æ—Ç–æ—Ä—ã–µ –≤–∞–º –ø–æ–Ω—Ä–∞–≤–∏–ª–∏—Å—å</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <div class="card h-100">
                                                <div class="card-body">
                                                    <i class="bi bi-robot display-4 text-success"></i>
                                                    <h5>2. –ê–Ω–∞–ª–∏–∑</h5>
                                                    <p>AI –∏–∑—É—á–∏—Ç –≤–∞—à–∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <div class="card h-100">
                                                <div class="card-body">
                                                    <i class="bi bi-lightbulb display-4 text-success"></i>
                                                    <h5>3. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</h5>
                                                    <p>–ü–æ–ª—É—á–∏—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <div class="card h-100">
                                                <div class="card-body">
                                                    <i class="bi bi-wine-glass display-4 text-success"></i>
                                                    <h5>4. –ù–∞—Å–ª–∞–∂–¥–∞–π—Ç–µ—Å—å</h5>
                                                    <p>–û—Ç–∫—Ä–æ–π—Ç–µ –Ω–æ–≤—ã–µ –ª—é–±–∏–º—ã–µ –≤–∏–Ω–∞</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –¢–ê–ë 3: –ü—Ä–æ—Å—Ç–æ–π –ø–æ–∏—Å–∫ -->
            <div class="tab-pane fade" id="simple-tab-pane" role="tabpanel">
                <div class="row">
                    <div class="col-lg-8 mx-auto">
                        <div class="filter-section text-center">
                            <h6><i class="bi bi-search"></i> –ü—Ä–æ—Å—Ç–æ–π –ø–æ–∏—Å–∫ –≤–∏–Ω–∞</h6>
                            
                            <div class="mb-4">
                                <label for="simpleQuery" class="form-label">–û–ø–∏—à–∏—Ç–µ, –∫–∞–∫–æ–µ –≤–∏–Ω–æ –≤—ã –∏—â–µ—Ç–µ:</label>
                                <textarea class="form-control" id="simpleQuery" rows="4" 
                                          placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: '–ò—â—É –ª–µ–≥–∫–æ–µ –±–µ–ª–æ–µ –≤–∏–Ω–æ —Å —Ü–∏—Ç—Ä—É—Å–æ–≤—ã–º–∏ –Ω–æ—Ç–∞–º–∏ –¥–ª—è –ª–µ—Ç–Ω–µ–≥–æ –≤–µ—á–µ—Ä–∞' 
–ò–ª–∏: '–ù—É–∂–Ω–æ –Ω–∞—Å—ã—â–µ–Ω–Ω–æ–µ –∫—Ä–∞—Å–Ω–æ–µ –≤–∏–Ω–æ —Å —Ç–∞–Ω–∏–Ω–∞–º–∏ –¥–ª—è –ø–æ–¥–∞—Ä–æ—á–∫–∞'
–ò–ª–∏: '–ü–æ—Å–æ–≤–µ—Ç—É–π—Ç–µ –∏–≥—Ä–∏—Å—Ç–æ–µ –≤–∏–Ω–æ –¥–ª—è –ø—Ä–∞–∑–¥–Ω–∏–∫–∞'"></textarea>
                            </div>
                            
                            <div class="d-grid gap-2 col-lg-6 mx-auto">
                                <button class="btn btn-primary btn-lg" onclick="getSimpleRecommendations()">
                                    <i class="bi bi-stars"></i> –ü–æ–ª—É—á–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
                                </button>
                            </div>
                            
                            <div class="mt-3">
                                <small class="text-muted">
                                    <i class="bi bi-info-circle"></i> –ü—Ä–æ—Å—Ç–æ –æ–ø–∏—à–∏—Ç–µ, —á—Ç–æ –≤–∞–º –Ω—É–∂–Ω–æ, –∏ AI –ø–æ–¥–±–µ—Ä–µ—Ç –ª—É—á—à–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã
                                </small>
                            </div>
                        </div>
                        
                        <div id="simpleResultsSection" style="display: none;" class="mt-4">
                            <div id="simpleLLMComment" class="card mb-4">
                                <div class="card-header bg-primary text-white">
                                    <i class="bi bi-chat-left-text"></i> AI-—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è
                                </div>
                                <div class="card-body">
                                    <p id="simpleLLMCommentText" class="fst-italic mb-0"></p>
                                </div>
                            </div>
                            
                            <h3 class="mb-3">–ü–æ–¥–æ–±—Ä–∞–Ω–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã</h3>
                            <div id="simpleResultsContainer" class="row"></div>
                        </div>
                        
                        <div class="mt-4">
                            <h6 class="text-muted mb-3"><i class="bi bi-lightning"></i> –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã:</h6>
                            <div class="d-flex flex-wrap gap-2 justify-content-center">
                                <button class="btn btn-sm btn-outline-primary" onclick="setSimpleQuery('–ò–≥—Ä–∏—Å—Ç–æ–µ –≤–∏–Ω–æ –¥–ª—è –ø—Ä–∞–∑–¥–Ω–∏–∫–∞')">–î–ª—è –ø—Ä–∞–∑–¥–Ω–∏–∫–∞</button>
                                <button class="btn btn-sm btn-outline-success" onclick="setSimpleQuery('–õ–µ–≥–∫–æ–µ —Ä–æ–∑–æ–≤–æ–µ –≤–∏–Ω–æ –¥–ª—è –ø–∏–∫–Ω–∏–∫–∞')">–î–ª—è –ø–∏–∫–Ω–∏–∫–∞</button>
                                <button class="btn btn-sm btn-outline-warning" onclick="setSimpleQuery('–ë–æ–≥–∞—Ç–æ–µ –∫—Ä–∞—Å–Ω–æ–µ –≤–∏–Ω–æ –¥–ª—è —Å—Ç–µ–π–∫–∞')">–î–ª—è —Å—Ç–µ–π–∫–∞</button>
                                <button class="btn btn-sm btn-outline-info" onclick="setSimpleQuery('–°–≤–µ–∂–µ–µ –±–µ–ª–æ–µ –≤–∏–Ω–æ –¥–ª—è –º–æ—Ä–µ–ø—Ä–æ–¥—É–∫—Ç–æ–≤')">–î–ª—è –º–æ—Ä–µ–ø—Ä–æ–¥—É–∫—Ç–æ–≤</button>
                                <button class="btn btn-sm btn-outline-danger" onclick="setSimpleQuery('–°–ª–∞–¥–∫–æ–µ –¥–µ—Å–µ—Ä—Ç–Ω–æ–µ –≤–∏–Ω–æ')">–î–µ—Å–µ—Ä—Ç–Ω–æ–µ</button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="setSimpleQuery('–ù–µ–æ–±—ã—á–Ω–æ–µ –≤–∏–Ω–æ –¥–ª—è –ø–æ–¥–∞—Ä–∫–∞')">–î–ª—è –ø–æ–¥–∞—Ä–∫–∞</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="wineDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="wineDetailsTitle"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="text-center">
                                <img id="wineDetailsImage" src="" alt="" class="img-fluid rounded mb-3" style="max-height: 300px; object-fit: cover;">
                                <div class="mb-3">
                                    <span id="wineDetailsRating" class="badge bg-warning fs-6"></span>
                                    <span id="wineDetailsPrice" class="badge bg-success fs-6 ms-2"></span>
                                </div>
                                <button class="btn btn-outline-danger w-100 mb-2" onclick="addToFavorites()">
                                    <i class="bi bi-heart"></i> –î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ
                                </button>
                                <button class="btn btn-outline-primary w-100" onclick="shareWine()">
                                    <i class="bi bi-share"></i> –ü–æ–¥–µ–ª–∏—Ç—å—Å—è
                                </button>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <h6><i class="bi bi-info-circle"></i> –û–ø–∏—Å–∞–Ω–∏–µ:</h6>
                            <p id="wineDetailsDescription" class="mb-3"></p>
                            
                            <div class="row mb-3">
                                <div class="col-6">
                                    <h6><i class="bi bi-geo-alt"></i> –ü—Ä–æ–∏—Å—Ö–æ–∂–¥–µ–Ω–∏–µ:</h6>
                                    <p id="wineDetailsOrigin" class="mb-0"></p>
                                </div>
                                <div class="col-6">
                                    <h6><i class="bi bi-graph-up"></i> –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:</h6>
                                    <p id="wineDetailsCharacteristics" class="mb-0"></p>
                                </div>
                            </div>
                            
                            <h6><i class="bi bi-emoji-smile"></i> AI-—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:</h6>
                            <div class="alert alert-light border" id="wineDetailsAIRecommendation">
                                <div class="spinner-border spinner-border-sm text-danger me-2"></div>
                                –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏...
                            </div>
                            
                            <h6><i class="bi bi-egg-fried"></i> –° —á–µ–º —Å–æ—á–µ—Ç–∞—Ç—å:</h6>
                            <div class="alert alert-light border" id="wineDetailsPairing">
                                <div class="spinner-border spinner-border-sm text-primary me-2"></div>
                                –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –ø–æ —Å–æ—á–µ—Ç–∞–Ω–∏—é...
                            </div>
                            
                            <h6><i class="bi bi-clock"></i> –ö–æ–≥–¥–∞ –ø–∏—Ç—å:</h6>
                            <div class="alert alert-light border" id="wineDetailsOccasion">
                                <div class="spinner-border spinner-border-sm text-success me-2"></div>
                                –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ª—É—á—à–∏–µ –º–æ–º–µ–Ω—Ç—ã...
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
                    <button type="button" class="btn btn-danger" onclick="saveWineForLater()">
                        <i class="bi bi-bookmark"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞ –ø–æ—Ç–æ–º
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="wine-recommender.js"></script>
    <script src="llm-service.js"></script>
    <script src="api.js"></script>
    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let allWines = [];
        let selectedWines = [];
        let filterResults = { current: [], page: 1 };
        let tasteResults = { current: [], page: 1 };
        let simpleResults = { current: [], page: 1 };
        const resultsPerPage = 6;

        // –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', async function() {
            console.log("üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è Wine Explorer...");
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º LLM —Å–µ—Ä–≤–∏—Å
            window.llmService.initialize();
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
            await initializeCountryFilter();
            await initializeVarietyFilter();
            await initializePriceFilter();
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –≤–∏–Ω
            await initializeWineSelectList();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –≤—ã–±–æ—Ä—ã
            loadSavedSelections();
            
            // –°–ª—É—à–∞—Ç–µ–ª—å –¥–ª—è —Å–ª–∞–π–¥–µ—Ä–∞ —Ü–µ–Ω—ã
            document.getElementById('maxPriceFilter').addEventListener('input', function() {
                document.getElementById('priceValue').textContent = `$${this.value}`;
            });
            
            console.log("‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ");
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–∞ —Å—Ç—Ä–∞–Ω
        async function initializeCountryFilter() {
            try {
                console.log("üåç –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Å—Ç—Ä–∞–Ω...");
                const countries = await API.filters.countries();
                const filter = document.getElementById('countryFilter');
                
                // –û—á–∏—â–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –æ–ø—Ü–∏–∏ –∫—Ä–æ–º–µ –ø–µ—Ä–≤–æ–π
                filter.innerHTML = '<option value="">–í—Å–µ —Å—Ç—Ä–∞–Ω—ã</option>';
                
                if (countries && countries.length > 0) {
                    countries.forEach(country => {
                        if (country && country !== 'Unknown' && country !== '' && country !== 'null') {
                            const option = document.createElement('option');
                            option.value = country;
                            option.textContent = country;
                            filter.appendChild(option);
                        }
                    });
                    
                    console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${countries.length} —Å—Ç—Ä–∞–Ω`);
                } else {
                    console.warn("‚ö†Ô∏è –°–ø–∏—Å–æ–∫ —Å—Ç—Ä–∞–Ω –ø—É—Å—Ç, –∑–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ");
                    loadTestCountries();
                }
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω:', error);
                loadTestCountries();
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–∞ —Å–æ—Ä—Ç–æ–≤
        async function initializeVarietyFilter() {
            try {
                console.log("üçá –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Å–æ—Ä—Ç–æ–≤...");
                const varieties = await API.filters.varieties();
                const filter = document.getElementById('varietyFilter');
                
                // –û—á–∏—â–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –æ–ø—Ü–∏–∏
                filter.innerHTML = '<option value="">–í—Å–µ —Å–æ—Ä—Ç–∞</option>';
                
                if (varieties && varieties.length > 0) {
                    varieties.forEach(variety => {
                        if (variety && variety !== 'Unknown' && variety !== '' && variety !== 'null') {
                            const option = document.createElement('option');
                            option.value = variety;
                            option.textContent = variety;
                            filter.appendChild(option);
                        }
                    });
                    
                    console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${varieties.length} —Å–æ—Ä—Ç–æ–≤`);
                } else {
                    console.warn("‚ö†Ô∏è –°–ø–∏—Å–æ–∫ —Å–æ—Ä—Ç–æ–≤ –ø—É—Å—Ç, –∑–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ");
                    loadTestVarieties();
                }
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Ä—Ç–æ–≤:', error);
                loadTestVarieties();
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ü–µ–Ω–æ–≤–æ–≥–æ —Ñ–∏–ª—å—Ç—Ä–∞
        async function initializePriceFilter() {
            try {
                console.log("üí∞ –ó–∞–≥—Ä—É–∑–∫–∞ —Ü–µ–Ω–æ–≤–æ–≥–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞...");
                const priceRange = await API.filters.priceRange();
                const slider = document.getElementById('maxPriceFilter');
                const valueSpan = document.getElementById('priceValue');
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω
                slider.min = Math.max(10, Math.floor(priceRange.min));
                slider.max = Math.min(500, Math.ceil(priceRange.max));
                slider.value = Math.min(100, Math.ceil(priceRange.max / 2));
                valueSpan.textContent = `$${slider.value}`;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥–ø–∏—Å–∏
                const labels = document.querySelectorAll('#maxPriceFilter + .d-flex small');
                if (labels[0]) labels[0].textContent = `$${slider.min}`;
                if (labels[1]) labels[1].textContent = `$${slider.max}+`;
                
                console.log(`‚úÖ –¶–µ–Ω–æ–≤–æ–π –¥–∏–∞–ø–∞–∑–æ–Ω: $${slider.min} - $${slider.max}`);
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ü–µ–Ω–æ–≤–æ–≥–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞:', error);
                // –û—Å—Ç–∞–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            }
        }

        // –¢–µ—Å—Ç–æ–≤—ã–µ —Å—Ç—Ä–∞–Ω—ã
        function loadTestCountries() {
            const filter = document.getElementById('countryFilter');
            const testCountries = [
                'France', 'Italy', 'Spain', 'USA', 'Chile', 'Argentina', 
                'Australia', 'Germany', 'Portugal', 'South Africa', 
                'New Zealand', 'Austria', 'Hungary', 'Greece'
            ];
            
            testCountries.forEach(country => {
                const option = document.createElement('option');
                option.value = country;
                option.textContent = country;
                filter.appendChild(option);
            });
            
            console.log(`‚ö†Ô∏è –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${testCountries.length} —Ç–µ—Å—Ç–æ–≤—ã—Ö —Å—Ç—Ä–∞–Ω`);
        }

        // –¢–µ—Å—Ç–æ–≤—ã–µ —Å–æ—Ä—Ç–∞
        function loadTestVarieties() {
            const filter = document.getElementById('varietyFilter');
            const testVarieties = [
                'Cabernet Sauvignon', 'Merlot', 'Pinot Noir', 'Syrah', 
                'Chardonnay', 'Sauvignon Blanc', 'Riesling', 'Malbec', 
                'Tempranillo', 'Sangiovese', 'Zinfandel', 'Pinot Grigio',
                'Grenache', 'Cabernet Franc', 'Carmenere'
            ];
            
            testVarieties.forEach(variety => {
                const option = document.createElement('option');
                option.value = variety;
                option.textContent = variety;
                filter.appendChild(option);
            });
            
            console.log(`‚ö†Ô∏è –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${testVarieties.length} —Ç–µ—Å—Ç–æ–≤—ã—Ö —Å–æ—Ä—Ç–æ–≤`);
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–ø–∏—Å–∫–∞ –≤–∏–Ω –¥–ª—è –≤—ã–±–æ—Ä–∞
        async function initializeWineSelectList() {
            try {
                console.log("üìã –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –≤–∏–Ω –¥–ª—è –≤—ã–±–æ—Ä–∞...");
                
                const container = document.getElementById('wineSelectList');
                container.innerHTML = '<div class="text-center p-3"><div class="spinner-border spinner-border-sm text-primary"></div><p class="mt-2">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –≤–∏–Ω...</p></div>';
                
                const data = await API.wines.list();
                allWines = data;
                renderWineSelectList();
                updateSelectedWinesList();
                
                console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${allWines.length} –≤–∏–Ω –¥–ª—è –≤—ã–±–æ—Ä–∞`);
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –≤–∏–Ω:', error);
                showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤–∏–Ω. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ.', 'warning');
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –≤–∏–Ω–∞
                allWines = [
                    { id: 1, name: "Cabernet Sauvignon Reserve", variety: "Cabernet Sauvignon", country: "France", price: 89.99, rating: 94 },
                    { id: 2, name: "Chardonnay Barrel Select", variety: "Chardonnay", country: "USA", price: 45.50, rating: 92 },
                    { id: 3, name: "Pinot Noir Elegance", variety: "Pinot Noir", country: "Italy", price: 68.00, rating: 93 },
                    { id: 4, name: "Sauvignon Blanc Fresh", variety: "Sauvignon Blanc", country: "New Zealand", price: 32.99, rating: 90 },
                    { id: 5, name: "Merlot Classic", variety: "Merlot", country: "Chile", price: 28.50, rating: 89 }
                ];
                
                renderWineSelectList();
                updateSelectedWinesList();
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
        async function refreshData() {
            showAlert('üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö...', 'info');
            
            try {
                // –û—á–∏—â–∞–µ–º –∫—ç—à
                localStorage.removeItem('wineData_v3');
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º API
                window.wineAPI = new WineAPI();
                window.API = {
                    filters: {
                        countries: async () => await window.wineAPI.getCountries(),
                        varieties: async () => await window.wineAPI.getVarieties(),
                        priceRange: async () => await window.wineAPI.getPriceRange()
                    },
                    recommend: {
                        filtered: async (data) => await window.wineAPI.getFilteredRecommendations(data.query, data.filters),
                        taste: async (data) => await window.wineAPI.getTasteRecommendations(data.selected_wines),
                        simple: async (data) => await window.wineAPI.getSimpleRecommendations(data.query)
                    },
                    wines: {
                        list: async () => await window.wineAPI.getWineList()
                    },
                    wine: {
                        'ai-comment': async (data) => await window.wineAPI.getWineAIComment(data.wine),
                        pairing: async (wineId) => await window.wineAPI.getWinePairing(wineId),
                        occasion: async (data) => await window.wineAPI.getWineOccasion(data.wine)
                    }
                };
                
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
                await initializeCountryFilter();
                await initializeVarietyFilter();
                await initializePriceFilter();
                await initializeWineSelectList();
                
                showAlert('‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã!', 'success');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:', error);
                showAlert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö', 'danger');
            }
        }

        // –ü–æ–∏—Å–∫ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
        async function getFilteredRecommendations() {
            const query = document.getElementById('searchQuery').value;
            const variety = document.getElementById('varietyFilter').value;
            const country = document.getElementById('countryFilter').value;
            const maxPrice = document.getElementById('maxPriceFilter').value;

            if (!query.trim()) {
                showAlert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–ø–∏—à–∏—Ç–µ, –∫–∞–∫–æ–µ –≤–∏–Ω–æ –≤—ã –∏—â–µ—Ç–µ.', 'warning');
                return;
            }

            showLoading('filter');
            
            try {
                const data = await API.recommend.filtered({
                    query: query,
                    filters: { 
                        variety: variety || null, 
                        country: country || null, 
                        max_price: maxPrice ? parseInt(maxPrice) : null 
                    }
                });

                hideLoading('filter');
                
                filterResults.current = data.recommendations;
                filterResults.page = 1;
                
                displayFilterResults();
                displayLLMComment('filter', data.llm_comment);
                
            } catch (error) {
                hideLoading('filter');
                showAlert(`–û—à–∏–±–∫–∞: ${error.message}`, 'danger');
            }
        }

        // –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –≤–∫—É—Å—É
        async function getTasteRecommendations() {
            if (selectedWines.length === 0) {
                showAlert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –≤–∏–Ω–æ', 'warning');
                return;
            }

            showLoading('taste');
            
            try {
                const data = await API.recommend.taste({
                    selected_wines: selectedWines.map(w => w.id)
                });

                hideLoading('taste');
                
                tasteResults.current = data.recommendations;
                tasteResults.page = 1;
                
                displayTasteResults();
                displayLLMComment('taste', data.llm_comment);
                displayPreferenceAnalysis(data.preference_analysis);
                
            } catch (error) {
                hideLoading('taste');
                showAlert(`–û—à–∏–±–∫–∞: ${error.message}`, 'danger');
            }
        }

        // –ü—Ä–æ—Å—Ç–æ–π –ø–æ–∏—Å–∫
        async function getSimpleRecommendations() {
            const query = document.getElementById('simpleQuery').value;
            
            if (!query.trim()) {
                showAlert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–ø–∏—à–∏—Ç–µ, –∫–∞–∫–æ–µ –≤–∏–Ω–æ –≤—ã –∏—â–µ—Ç–µ.', 'warning');
                return;
            }

            showLoading('simple');
            
            try {
                const data = await API.recommend.simple({
                    query: query
                });

                hideLoading('simple');
                
                simpleResults.current = data.recommendations;
                simpleResults.page = 1;
                
                displaySimpleResults();
                displayLLMComment('simple', data.llm_comment);
                
            } catch (error) {
                hideLoading('simple');
                showAlert(`–û—à–∏–±–∫–∞: ${error.message}`, 'danger');
            }
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        function displayFilterResults() {
            const section = document.getElementById('filterResultsSection');
            const welcome = document.getElementById('filterWelcome');
            const count = document.getElementById('filterResultsCount');
            const container = document.getElementById('filterResultsContainer');
            const pagination = document.getElementById('filterPagination');

            if (filterResults.current.length === 0) {
                container.innerHTML = '<div class="col-12"><div class="alert alert-info">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞.</div></div>';
                count.textContent = '–ù–∞–π–¥–µ–Ω–æ 0 –≤–∏–Ω';
                section.style.display = 'block';
                welcome.style.display = 'none';
                pagination.style.display = 'none';
                return;
            }

            count.textContent = `–ù–∞–π–¥–µ–Ω–æ ${filterResults.current.length} –≤–∏–Ω`;
            displayResultsPage('filter');
            
            if (filterResults.current.length > resultsPerPage) {
                setupPagination('filter');
                pagination.style.display = 'flex';
            } else {
                pagination.style.display = 'none';
            }
            
            section.style.display = 'block';
            welcome.style.display = 'none';
        }

        function displayTasteResults() {
            const section = document.getElementById('tasteResultsSection');
            const welcome = document.getElementById('tasteWelcome');
            const count = document.getElementById('tasteResultsCount');
            const container = document.getElementById('tasteResultsContainer');

            if (tasteResults.current.length === 0) {
                container.innerHTML = '<div class="col-12"><div class="alert alert-info">–ù–µ—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–∏–µ –≤–∏–Ω–∞.</div></div>';
                count.textContent = '–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ (0)';
            } else {
                count.textContent = `–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ (${tasteResults.current.length})`;
                displayResultsPage('taste');
            }
            
            section.style.display = 'block';
            welcome.style.display = 'none';
        }

        function displaySimpleResults() {
            const section = document.getElementById('simpleResultsSection');
            const container = document.getElementById('simpleResultsContainer');

            if (simpleResults.current.length === 0) {
                container.innerHTML = '<div class="col-12"><div class="alert alert-info">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å.</div></div>';
            } else {
                displayResultsPage('simple');
            }
            
            section.style.display = 'block';
        }

        // –†–∞–±–æ—Ç–∞ —Å–æ —Å–ø–∏—Å–∫–æ–º –≤–∏–Ω
        function renderWineSelectList(filterText = '') {
            const container = document.getElementById('wineSelectList');
            
            if (!allWines || allWines.length === 0) {
                container.innerHTML = '<div class="text-center p-3 text-muted"><i class="bi bi-exclamation-triangle"></i><br>–°–ø–∏—Å–æ–∫ –≤–∏–Ω –ø—É—Å—Ç</div>';
                return;
            }
            
            const filteredWines = allWines.filter(wine => {
                if (!filterText) return true;
                const searchStr = `${wine.name} ${wine.variety} ${wine.country}`.toLowerCase();
                return searchStr.includes(filterText.toLowerCase());
            });

            if (filteredWines.length === 0) {
                container.innerHTML = '<div class="text-center p-3 text-muted">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
                return;
            }

            container.innerHTML = '';
            
            filteredWines.forEach(wine => {
                const isSelected = selectedWines.some(sw => sw.id === wine.id);
                const item = document.createElement('div');
                item.className = `wine-select-item ${isSelected ? 'selected' : ''}`;
                item.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${wine.name}</strong>
                            <br>
                            <small class="text-muted">
                                ${wine.variety} ‚Ä¢ ${wine.country} ‚Ä¢ $${wine.price}
                            </small>
                        </div>
                        <div>
                            <span class="badge bg-${getWineTypeColor(wine.variety)} badge-small">${wine.rating}/100</span>
                        </div>
                    </div>
                `;
                
                item.onclick = (e) => {
                    e.stopPropagation();
                    toggleWineSelection(wine);
                };
                
                container.appendChild(item);
            });
        }

        function toggleWineSelection(wine) {
            const index = selectedWines.findIndex(w => w.id === wine.id);
            
            if (index === -1) {
                selectedWines.push(wine);
            } else {
                selectedWines.splice(index, 1);
            }
            
            updateSelectedWinesList();
            renderWineSelectList(document.getElementById('wineSearch').value);
            saveSelections();
            
            document.getElementById('tasteRecommendBtn').disabled = selectedWines.length === 0;
        }

        function updateSelectedWinesList() {
            const container = document.getElementById('selectedWinesList');
            const count = document.getElementById('selectedCount');
            
            count.textContent = selectedWines.length;
            
            if (selectedWines.length === 0) {
                container.innerHTML = '<div class="text-center text-muted p-3"><i class="bi bi-inbox"></i><br>–í—ã–±–µ—Ä–∏—Ç–µ –≤–∏–Ω–∞ –∏–∑ —Å–ø–∏—Å–∫–∞</div>';
                return;
            }
            
            container.innerHTML = selectedWines.map((wine, index) => `
                <div class="selected-wine-card card mb-2">
                    <div class="card-body p-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div style="flex: 1;">
                                <strong>${wine.name}</strong>
                                <div class="text-muted" style="font-size: 0.8em;">
                                    ${wine.variety} ‚Ä¢ ${wine.country} ‚Ä¢ $${wine.price}
                                </div>
                            </div>
                            <div>
                                <span class="badge bg-${getWineTypeColor(wine.variety)}">${wine.rating}</span>
                                <button class="btn btn-sm btn-outline-danger remove-btn ms-2" 
                                        onclick="removeSelectedWine(${index})">
                                    <i class="bi bi-x"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function removeSelectedWine(index) {
            selectedWines.splice(index, 1);
            updateSelectedWinesList();
            renderWineSelectList(document.getElementById('wineSearch').value);
            saveSelections();
            document.getElementById('tasteRecommendBtn').disabled = selectedWines.length === 0;
        }

        function clearSelectedWines() {
            if (selectedWines.length === 0) return;
            
            if (confirm(`–£–¥–∞–ª–∏—Ç—å –≤—Å–µ ${selectedWines.length} –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –≤–∏–Ω?`)) {
                selectedWines = [];
                updateSelectedWinesList();
                renderWineSelectList(document.getElementById('wineSearch').value);
                saveSelections();
                document.getElementById('tasteRecommendBtn').disabled = true;
                showAlert('–í—Å–µ –≤–∏–Ω–∞ —É–¥–∞–ª–µ–Ω—ã –∏–∑ –≤—ã–±–æ—Ä–∞', 'info');
            }
        }

        function filterWineList() {
            const filterText = document.getElementById('wineSearch').value;
            renderWineSelectList(filterText);
        }

        function displayPreferenceAnalysis(analysis) {
            const container = document.getElementById('preferenceAnalysis');
            
            if (!analysis || Object.keys(analysis).length === 0) {
                container.innerHTML = '<div class="col-12"><p class="text-muted">–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</p></div>';
                return;
            }
            
            let html = '';
            
            if (analysis.favorite_varieties && analysis.favorite_varieties.length > 0) {
                html += `
                    <div class="col-md-6 mb-3">
                        <h6><i class="bi bi-graph-up text-primary"></i> –õ—é–±–∏–º—ã–µ —Å–æ—Ä—Ç–∞:</h6>
                        <div class="d-flex flex-wrap gap-1">
                            ${analysis.favorite_varieties.map(v => `
                                <span class="badge bg-primary">${v.variety} (${v.count})</span>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            if (analysis.preferred_countries && analysis.preferred_countries.length > 0) {
                html += `
                    <div class="col-md-6 mb-3">
                        <h6><i class="bi bi-globe text-success"></i> –ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ–º—ã–µ —Å—Ç—Ä–∞–Ω—ã:</h6>
                        <div class="d-flex flex-wrap gap-1">
                            ${analysis.preferred_countries.map(c => `
                                <span class="badge bg-success">${c.country} (${c.count})</span>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            if (analysis.average_price) {
                html += `
                    <div class="col-md-6 mb-3">
                        <h6><i class="bi bi-currency-dollar text-warning"></i> –°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞:</h6>
                        <p class="mb-0">$${analysis.average_price.toFixed(2)}</p>
                    </div>
                `;
            }
            
            if (analysis.average_rating) {
                html += `
                    <div class="col-md-6 mb-3">
                        <h6><i class="bi bi-star text-info"></i> –°—Ä–µ–¥–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥:</h6>
                        <p class="mb-0">${analysis.average_rating.toFixed(1)}/100</p>
                    </div>
                `;
            }
            
            if (analysis.price_range) {
                html += `
                    <div class="col-md-12 mb-3">
                        <h6><i class="bi bi-cash-stack text-danger"></i> –î–∏–∞–ø–∞–∑–æ–Ω —Ü–µ–Ω:</h6>
                        <p class="mb-0">–û—Ç $${analysis.price_range.min} –¥–æ $${analysis.price_range.max}</p>
                    </div>
                `;
            }
            
            container.innerHTML = html || '<div class="col-12"><p class="text-muted">–ê–Ω–∞–ª–∏–∑ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</p></div>';
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function displayResultsPage(tab) {
            let results, container;
            
            if (tab === 'filter') {
                results = filterResults.current;
                container = document.getElementById('filterResultsContainer');
            } else if (tab === 'taste') {
                results = tasteResults.current;
                container = document.getElementById('tasteResultsContainer');
            } else {
                results = simpleResults.current;
                container = document.getElementById('simpleResultsContainer');
            }
            
            const startIndex = (results.page - 1) * resultsPerPage;
            const endIndex = startIndex + resultsPerPage;
            const pageResults = results.slice(startIndex, endIndex);

            container.innerHTML = pageResults.map((wine, index) => createWineCard(wine, startIndex + index + 1)).join('');
        }

        function createWineCard(wine, number) {
            const similarityPercentage = Math.round(wine.similarity_score * 100);
            
            return `
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card wine-card h-100" onclick="showWineDetails(${JSON.stringify(wine).replace(/"/g, '&quot;')})" style="cursor: pointer;">
                        <div class="wine-type-badge">
                            <span class="badge ${getVarietyBadgeClass(wine.variety)}">${wine.variety}</span>
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <span class="badge bg-secondary">#${number}</span>
                                    <h5 class="card-title mt-2 mb-1">${wine.title || wine.name}</h5>
                                </div>
                                <span class="price-tag">$${wine.price}</span>
                            </div>
                            
                            <div class="mb-3">
                                <span class="badge bg-light text-dark">
                                    <i class="bi bi-geo-alt"></i> ${wine.country}
                                </span>
                                <span class="badge bg-light text-dark ms-1">
                                    <i class="bi bi-star-fill text-warning"></i> ${wine.points || wine.rating}/100
                                </span>
                            </div>
                            
                            <p class="card-text text-muted" style="font-size: 0.9em; height: 60px; overflow: hidden;">
                                ${wine.llm_comment ? wine.llm_comment.substring(0, 120) + '...' : (wine.description ? wine.description.substring(0, 120) + '...' : '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç')}
                            </p>
                            
                            <div class="mt-3">
                                <div class="d-flex justify-content-between mb-1">
                                    <small class="text-muted">–°–æ–≤–ø–∞–¥–µ–Ω–∏–µ:</small>
                                    <small class="fw-bold" style="color: ${getSimilarityColor(similarityPercentage)}">
                                        ${similarityPercentage}%
                                    </small>
                                </div>
                                <div class="similarity-meter">
                                    <div class="similarity-fill" style="width: ${similarityPercentage}%"></div>
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-between mt-3">
                                <button class="btn btn-sm btn-outline-danger" onclick="event.stopPropagation(); addToFavorites('${wine.id}')">
                                    <i class="bi bi-heart"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                                </button>
                                <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); getPairingRecommendation('${wine.id}')">
                                    <i class="bi bi-egg-fried"></i> –ß—Ç–æ –∫ –Ω–µ–º—É?
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function setupPagination(tab) {
            let results, paginationId;
            
            if (tab === 'filter') {
                results = filterResults.current;
                paginationId = 'filterPagination';
            }
            
            const totalPages = Math.ceil(results.length / resultsPerPage);
            const pagination = document.getElementById(paginationId);
            const ul = pagination.querySelector('ul');
            
            ul.innerHTML = '';
            
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${results.page === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#" onclick="changePage('${tab}', ${results.page - 1}); return false;"><i class="bi bi-chevron-left"></i></a>`;
            ul.appendChild(prevLi);
            
            for (let i = 1; i <= totalPages; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${i === results.page ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#" onclick="changePage('${tab}', ${i}); return false;">${i}</a>`;
                ul.appendChild(li);
            }
            
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${results.page === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#" onclick="changePage('${tab}', ${results.page + 1}); return false;"><i class="bi bi-chevron-right"></i></a>`;
            ul.appendChild(nextLi);
        }

        function changePage(tab, page) {
            let results;
            if (tab === 'filter') results = filterResults;
            else if (tab === 'taste') results = tasteResults;
            else results = simpleResults;
            
            const totalPages = Math.ceil(results.current.length / resultsPerPage);
            if (page < 1 || page > totalPages) return;
            
            results.page = page;
            displayResultsPage(tab);
            
            if (tab === 'filter') setupPagination(tab);
            
            const resultsSection = document.getElementById(`${tab}ResultsSection`);
            if (resultsSection) {
                window.scrollTo({
                    top: resultsSection.offsetTop - 100,
                    behavior: 'smooth'
                });
            }
        }

        function sortResults(criteria, tab) {
            let results;
            if (tab === 'filter') results = filterResults.current;
            else if (tab === 'taste') results = tasteResults.current;
            else results = simpleResults.current;

            switch(criteria) {
                case 'similarity': results.sort((a, b) => b.similarity_score - a.similarity_score); break;
                case 'price': results.sort((a, b) => a.price - b.price); break;
                case 'rating': results.sort((a, b) => (b.points || b.rating) - (a.points || a.rating)); break;
            }

            if (tab === 'filter') displayResultsPage('filter');
            else if (tab === 'taste') displayResultsPage('taste');
            else displayResultsPage('simple');
        }

        function displayLLMComment(tab, comment) {
            const element = document.getElementById(`${tab}LLMCommentText`);
            if (element) {
                element.textContent = comment;
            }
        }

        function showLoading(tab) {
            const btn = document.querySelector(`#${tab}-tab-pane .btn-primary`);
            if (btn) {
                btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> –ó–∞–≥—Ä—É–∑–∫–∞...';
                btn.disabled = true;
            }
        }

        function hideLoading(tab) {
            const btn = document.querySelector(`#${tab}-tab-pane .btn-primary`);
            if (btn) {
                if (tab === 'filter') btn.innerHTML = '<i class="bi bi-search"></i> –ù–∞–π—Ç–∏ –≤–∏–Ω–∞';
                else if (tab === 'taste') btn.innerHTML = '<i class="bi bi-magic"></i> –ü–æ–ª—É—á–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏';
                else btn.innerHTML = '<i class="bi bi-stars"></i> –ü–æ–ª—É—á–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏';
                btn.disabled = false;
            }
        }

        function getWineTypeColor(variety) {
            if (!variety) return 'secondary';
            const redVarieties = ['Cabernet', 'Merlot', 'Pinot Noir', 'Syrah', 'Malbec', 'Zinfandel', 'Sangiovese', 'Tempranillo', 'Red Blend'];
            const whiteVarieties = ['Chardonnay', 'Sauvignon', 'Riesling', 'Pinot Gris', 'Pinot Grigio'];
            
            if (redVarieties.some(v => variety.includes(v))) return 'danger';
            if (whiteVarieties.some(v => variety.includes(v))) return 'warning';
            return 'secondary';
        }

        function getVarietyBadgeClass(variety) {
            const color = getWineTypeColor(variety);
            return `bg-${color} ${color === 'warning' ? 'text-dark' : ''}`;
        }

        function getSimilarityColor(percentage) {
            if (percentage >= 80) return '#28a745';
            if (percentage >= 60) return '#ffc107';
            return '#dc3545';
        }

        function saveSelections() {
            localStorage.setItem('selectedWines', JSON.stringify(selectedWines));
        }

        function loadSavedSelections() {
            const saved = localStorage.getItem('selectedWines');
            if (saved) {
                try {
                    selectedWines = JSON.parse(saved);
                    updateSelectedWinesList();
                    renderWineSelectList();
                    document.getElementById('tasteRecommendBtn').disabled = selectedWines.length === 0;
                } catch (e) {
                    console.error('Error loading saved selections:', e);
                }
            }
        }

        function resetFilters() {
            document.getElementById('searchQuery').value = '';
            document.getElementById('varietyFilter').value = '';
            document.getElementById('countryFilter').value = '';
            document.getElementById('maxPriceFilter').value = 100;
            document.getElementById('priceValue').textContent = '$100';
            
            document.getElementById('filterResultsSection').style.display = 'none';
            document.getElementById('filterWelcome').style.display = 'block';
            
            showAlert('–§–∏–ª—å—Ç—Ä—ã —Å–±—Ä–æ—à–µ–Ω—ã', 'info', 2000);
        }

        function setSimpleQuery(query) {
            document.getElementById('simpleQuery').value = query;
        }

        // –î–µ—Ç–∞–ª–∏ –≤–∏–Ω–∞
        function showWineDetails(wine) {
            const modalElement = document.getElementById('wineDetailsModal');
            
            document.getElementById('wineDetailsTitle').textContent = wine.title || wine.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
            document.getElementById('wineDetailsDescription').textContent = wine.description || '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç';
            document.getElementById('wineDetailsRating').textContent = `–†–µ–π—Ç–∏–Ω–≥: ${wine.points || wine.rating || 0}/100`;
            document.getElementById('wineDetailsPrice').textContent = `$${wine.price || 0}`;
            
            let origin = wine.country || '–ù–µ —É–∫–∞–∑–∞–Ω–∞';
            if (wine.region_1 && wine.region_1 !== 'Unknown') {
                origin += ` ‚Ä¢ ${wine.region_1}`;
            }
            document.getElementById('wineDetailsOrigin').textContent = origin;
            
            let characteristics = wine.variety || '–°–æ—Ä—Ç –Ω–µ —É–∫–∞–∑–∞–Ω';
            if (wine.winery) {
                characteristics += ` ‚Ä¢ ${wine.winery}`;
            }
            document.getElementById('wineDetailsCharacteristics').textContent = characteristics;
            
            const wineImage = document.getElementById('wineDetailsImage');
            const searchTerm = encodeURIComponent((wine.variety || 'wine') + ' bottle');
            wineImage.src = `https://source.unsplash.com/300x300/?${searchTerm}`;
            wineImage.alt = wine.title || wine.name;
            
            // AI –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
            generateWineAIComment(wine);
            
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
            
            modalElement.dataset.currentWineId = wine.id;
            modalElement.dataset.currentWineName = wine.title || wine.name;
        }
        
        async function generateWineAIComment(wine) {
            const commentElement = document.getElementById('wineDetailsAIRecommendation');
            
            try {
                const data = await API.wine['ai-comment']({ wine });
                commentElement.innerHTML = `<i class="bi bi-robot text-danger me-2"></i>${data.comment}`;
            } catch (error) {
                commentElement.innerHTML = '<i class="bi bi-exclamation-triangle text-warning me-2"></i>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é';
            }
            
            loadWinePairing(wine.id);
            loadWineOccasion(wine);
        }
        
        async function loadWinePairing(wineId) {
            const pairingElement = document.getElementById('wineDetailsPairing');
            
            try {
                const data = await API.wine.pairing(wineId);
                pairingElement.innerHTML = `<i class="bi bi-egg-fried text-primary me-2"></i>${data.pairing}`;
            } catch (error) {
                pairingElement.innerHTML = '<i class="bi bi-exclamation-triangle text-warning me-2"></i>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Å–æ—á–µ—Ç–∞–Ω–∏—é';
            }
        }
        
        async function loadWineOccasion(wine) {
            const occasionElement = document.getElementById('wineDetailsOccasion');
            
            try {
                const data = await API.wine.occasion({ wine });
                occasionElement.innerHTML = `<i class="bi bi-clock text-success me-2"></i>${data.occasion}`;
            } catch (error) {
                occasionElement.innerHTML = '<i class="bi bi-exclamation-triangle text-warning me-2"></i>–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –º–æ–º–µ–Ω—Ç—ã';
            }
        }
        
        function addToFavorites(wineId = null) {
            try {
                if (!wineId) {
                    const modal = document.getElementById('wineDetailsModal');
                    wineId = modal?.dataset.currentWineId;
                }
                
                if (!wineId) {
                    showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤–∏–Ω–æ', 'warning');
                    return;
                }
                
                let favorites = JSON.parse(localStorage.getItem('wineFavorites') || '[]');
                
                if (favorites.includes(wineId)) {
                    showAlert('–≠—Ç–æ –≤–∏–Ω–æ —É–∂–µ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–º!', 'info');
                    return;
                }
                
                favorites.push(wineId);
                
                if (favorites.length > 50) {
                    favorites = favorites.slice(-50);
                }
                
                localStorage.setItem('wineFavorites', JSON.stringify(favorites));
                
                showAlert('<i class="bi bi-heart-fill text-danger"></i> –í–∏–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ!', 'success');
                
                updateFavoriteIcon(wineId, true);
                
                triggerHeartAnimation();
                
            } catch (error) {
                console.error('Error adding to favorites:', error);
                showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ', 'danger');
            }
        }
        
        function triggerHeartAnimation() {
            const heart = document.createElement('div');
            heart.innerHTML = '<i class="bi bi-heart-fill text-danger" style="font-size: 2rem;"></i>';
            heart.style.cssText = `
                position: fixed;
                z-index: 9999;
                animation: floatUp 1.5s ease-out forwards;
                pointer-events: none;
            `;
            
            heart.style.left = '50%';
            heart.style.top = '50%';
            heart.style.transform = 'translate(-50%, -50%)';
            
            document.body.appendChild(heart);
            
            const style = document.createElement('style');
            style.textContent = `
                @keyframes floatUp {
                    0% {
                        opacity: 1;
                        transform: translate(-50%, -50%) scale(1);
                    }
                    100% {
                        opacity: 0;
                        transform: translate(-50%, -150px) scale(1.5);
                    }
                }
            `;
            document.head.appendChild(style);
            
            setTimeout(() => {
                heart.remove();
                style.remove();
            }, 1500);
        }
        
        function updateFavoriteIcon(wineId, isFavorite) {
            const buttons = document.querySelectorAll(`[onclick*="addToFavorites('${wineId}')"]`);
            buttons.forEach(btn => {
                if (isFavorite) {
                    btn.innerHTML = '<i class="bi bi-heart-fill"></i> –í –∏–∑–±—Ä–∞–Ω–Ω–æ–º';
                    btn.classList.remove('btn-outline-danger');
                    btn.classList.add('btn-danger');
                } else {
                    btn.innerHTML = '<i class="bi bi-heart"></i> –í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ';
                    btn.classList.remove('btn-danger');
                    btn.classList.add('btn-outline-danger');
                }
            });
        }
        
        async function getPairingRecommendation(wineId) {
            try {
                showAlert('<div class="spinner-border spinner-border-sm me-2"></div> –ò—â–µ–º –∏–¥–µ–∞–ª—å–Ω—ã–µ —Å–æ—á–µ—Ç–∞–Ω–∏—è...', 'info', 5000);
                
                const data = await API.wine.pairing(wineId);
                
                const pairingModalHTML = `
                <div class="modal fade" id="pairingModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header bg-primary text-white">
                                <h5 class="modal-title"><i class="bi bi-egg-fried"></i> –ò–¥–µ–∞–ª—å–Ω—ã–µ —Å–æ—á–µ—Ç–∞–Ω–∏—è</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-light">
                                    <h6><i class="bi bi-lightbulb text-warning"></i> –°–æ–≤–µ—Ç—ã –æ—Ç –Ω–∞—à–µ–≥–æ AI-—Å–æ–º–µ–ª—å–µ:</h6>
                                    <p class="mb-0 mt-2">${data.pairing}</p>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
                            </div>
                        </div>
                    </div>
                </div>
                `;
                
                const oldModal = document.getElementById('pairingModal');
                if (oldModal) oldModal.remove();
                
                document.body.insertAdjacentHTML('beforeend', pairingModalHTML);
                
                const modal = new bootstrap.Modal(document.getElementById('pairingModal'));
                modal.show();
                
            } catch (error) {
                console.error('Error getting pairing recommendation:', error);
                showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Å–æ—á–µ—Ç–∞–Ω–∏—é', 'danger');
            }
        }

        // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        function showAlert(message, type = 'info', duration = 3000) {
            const oldAlerts = document.querySelectorAll('.alert-toast');
            oldAlerts.forEach(alert => {
                if (alert.parentNode) {
                    alert.remove();
                }
            });
        
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-toast position-fixed`;
            alertDiv.style.cssText = `
                top: 20px;
                right: 20px;
                z-index: 1050;
                min-width: 300px;
                max-width: 400px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                border-radius: 8px;
                animation: slideIn 0.3s ease;
            `;
            
            const icons = {
                'success': 'bi-check-circle-fill',
                'danger': 'bi-exclamation-triangle-fill',
                'warning': 'bi-exclamation-circle-fill',
                'info': 'bi-info-circle-fill'
            };
            
            alertDiv.innerHTML = `
                <div class="d-flex align-items-start">
                    <div class="flex-shrink-0 me-2">
                        <i class="bi ${icons[type] || 'bi-info-circle-fill'}"></i>
                    </div>
                    <div class="flex-grow-1">
                        <div style="white-space: pre-wrap;">${message}</div>
                    </div>
                    <div class="flex-shrink-0 ms-2">
                        <button type="button" class="btn-close btn-sm" onclick="this.parentElement.parentElement.parentElement.remove()"></button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(alertDiv);
            
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from {
                        transform: translateX(100%);
                        opacity: 0;
                    }
                    to {
                        transform: translateX(0);
                        opacity: 1;
                    }
                }
                @keyframes slideOut {
                    from {
                        transform: translateX(0);
                        opacity: 1;
                    }
                    to {
                        transform: translateX(100%);
                        opacity: 0;
                    }
                }
            `;
            document.head.appendChild(style);
            
            if (duration > 0) {
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.style.animation = 'slideOut 0.3s ease';
                        setTimeout(() => {
                            if (alertDiv.parentNode) {
                                alertDiv.remove();
                            }
                        }, 300);
                    }
                }, duration);
            }
            
            document.addEventListener('click', function removeAlertOnOutsideClick(e) {
                if (!alertDiv.contains(e.target) && !e.target.classList.contains('btn-close')) {
                    if (alertDiv.parentNode) {
                        alertDiv.remove();
                        document.removeEventListener('click', removeAlertOnOutsideClick);
                    }
                }
            });
        }

        // –ó–∞–≥–ª—É—à–∫–∏ –¥–ª—è –Ω–µ—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π
        function shareWine() {
            showAlert('–§—É–Ω–∫—Ü–∏—è "–ü–æ–¥–µ–ª–∏—Ç—å—Å—è" –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 'info');
        }

        function saveWineForLater() {
            showAlert('–í–∏–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–æ–∑–∂–µ', 'success');
        }
    </script>
</body>
</html>
